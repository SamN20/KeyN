{% extends 'base.html' %}
{% block title %}Client Applications - Admin{% endblock %}
{% block containerType %}<div class="admin-container">{% endblock %}
{% block content %}
<div class="clients-wrapper">
  <div class="clients-header">
    <div class="header-icon">
      <i class="fas fa-plug"></i>
    </div>
    <div class="header-text">
      <h1>Client Applications</h1>
      <p class="subtitle">Manage OAuth / API client credentials & authorized redirect URIs</p>
    </div>
    <a href="/admin" class="back-link"><i class="fas fa-arrow-left"></i><span>Back to Admin</span></a>
  </div>

  <div id="actionStatus"></div>

  <div class="layout-grid">
    <div class="panel panel-list">
      <div class="panel-header">
        <h2><i class="fas fa-list"></i> Existing Clients</h2>
      </div>
      <div class="panel-body" id="clientsTableContainer">
        <div class="table-responsive">
          <table class="clients-table">
            <thead>
              <tr><th>Name</th><th>Client ID</th><th>Website</th><th>Redirect URIs</th><th>Created</th><th>Actions</th></tr>
            </thead>
            <tbody>
            {% for c in clients %}
              <tr>
                <td class="client-name">{{ c.name }}</td>
                <td class="client-id"><code class="mono">{{ c.client_id }}</code></td>
                <td class="website-col">
                  {% if c.website_url %}
                    <a href="{{ c.website_url }}" target="_blank" rel="noopener" class="site-link"><i class="fas fa-external-link-alt"></i>{{ c.website_url }}</a>
                  {% else %}
                    <span class="muted">â€”</span>
                  {% endif %}
                </td>
                <td>
                  <ul class="redirect-list">
                    {% for u in c.get_redirect_uris() %}<li><i class="fas fa-link"></i>{{ u }}</li>{% endfor %}
                  </ul>
                </td>
                <td class="date-col">{{ c.created_at.strftime('%Y-%m-%d') if c.created_at else '' }}</td>
                <td class="action-col">
                  <button class="btn btn-small" onclick="openUpdateModal('{{ c.client_id }}')"><i class="fas fa-edit"></i><span>Update</span></button>
                  <button class="btn btn-small warn" onclick="rotateSecret('{{ c.client_id }}')"><i class="fas fa-sync"></i><span>Rotate</span></button>
                  <button class="btn btn-small danger" onclick="deleteClient('{{ c.client_id }}')"><i class="fas fa-trash"></i><span>Delete</span></button>
                </td>
              </tr>
            {% endfor %}
            {% if not clients %}
              <tr><td colspan="6"><div class="empty-state"><i class="fas fa-plug"></i><h3>No Clients</h3><p>Create a client using the form on the right.</p></div></td></tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="panel panel-form">
      <div class="panel-header">
        <h2><i class="fas fa-plus-circle"></i> Create New Client</h2>
      </div>
      <div class="panel-body">
        <form id="createClientForm" onsubmit="submitCreate(event)">
          <div class="form-group">
            <label>Name</label>
            <input name="name" required placeholder="Application Name" />
          </div>
          <div class="form-group">
            <label>Website URL</label>
            <input name="website_url" placeholder="https://example.com" />
          </div>
            <div class="form-group">
              <label>Description</label>
              <textarea name="description" rows="2" placeholder="Short description (optional)"></textarea>
            </div>
            <div class="form-group">
              <label>Redirect URIs <span class="hint">(one per line)</span></label>
              <textarea name="redirect_uris" rows="4" required placeholder="https://example.com/callback"></textarea>
            </div>
            <div class="form-footnote">An email confirmation is required before the client is created.</div>
            <button class="btn primary full" type="submit"><i class="fas fa-paper-plane"></i><span>Request Creation</span></button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Update Modal -->
<div class="modal-overlay" id="updateModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Update Client</h3>
      <button class="close" onclick="closeUpdateModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <form id="updateClientForm" onsubmit="submitUpdate(event)">
        <input type="hidden" name="client_id" />
        <div class="form-group">
          <label>New Name <span class="optional">(optional)</span></label>
          <input name="name" placeholder="Leave blank to keep current" />
        </div>
        <div class="form-group">
          <label>New Website URL <span class="optional">(optional)</span></label>
          <input name="website_url" placeholder="https://example.com (leave blank to keep current)" />
        </div>
        <div class="form-group">
          <label>New Description <span class="optional">(optional)</span></label>
          <textarea name="description" rows="2" placeholder="Leave blank to keep current"></textarea>
        </div>
        <div class="form-group">
          <label>Redirect URIs <span class="optional">(optional)</span></label>
          <textarea name="redirect_uris" rows="4" placeholder="Provide full list to replace existing (one per line)"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="closeUpdateModal()">Cancel</button>
          <button type="submit" class="btn primary"><i class="fas fa-paper-plane"></i><span>Submit Update</span></button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.admin-container {min-height:100vh;padding:20px;background:var(--bg-color);} 
.clients-wrapper {max-width:1400px;margin:0 auto;}
.clients-header {display:flex;align-items:center;gap:20px;margin-bottom:32px;flex-wrap:wrap;}
.header-icon {width:70px;height:70px;border-radius:18px;background:linear-gradient(135deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;color:#fff;font-size:30px;box-shadow:0 8px 25px rgba(0,0,0,0.15);} 
.header-text h1 {margin:0;font-size:34px;font-weight:700;color:var(--text-color);} 
.header-text .subtitle {margin:4px 0 0;color:var(--secondary-color);font-size:16px;} 
.back-link {margin-left:auto;display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;text-decoration:none;font-weight:500;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.3);color:#6366f1;transition:.2s;} 
.back-link:hover {background:rgba(99,102,241,0.18);transform:translateY(-2px);} 
.layout-grid {display:grid;grid-template-columns:2fr 1fr;gap:28px;align-items:start;} 
.panel {background:var(--card-bg);border:1px solid var(--border-color);border-radius:20px;box-shadow:0 8px 25px rgba(0,0,0,0.08);overflow:hidden;display:flex;flex-direction:column;} 
.panel-header {padding:22px 26px;border-bottom:1px solid var(--border-color);background:linear-gradient(135deg,var(--card-bg) 0%, var(--bg-color) 100%);} 
.panel-header h2 {margin:0;font-size:20px;font-weight:600;display:flex;align-items:center;gap:10px;color:var(--text-color);} 
.panel-body {padding:24px 26px;} 
.table-responsive {overflow-x:auto;} 
.clients-table {width:100%;border-collapse:collapse;font-size:14px;} 
.clients-table th {background:#4338ca;color:#fff;padding:12px 14px;text-align:left;font-weight:600;font-size:13px;letter-spacing:.5px;} 
.clients-table td {padding:12px 14px;border-bottom:1px solid var(--border-color);vertical-align:top;} 
.website-col .site-link {display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#6366f1;text-decoration:none;word-break:break-all;}
.website-col .site-link:hover {text-decoration:underline;}
.muted {color:var(--secondary-color);font-size:12px;}
.clients-table tbody tr:hover {background:var(--bg-color);} 
.redirect-list {list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:4px;} 
.redirect-list li {display:flex;gap:6px;align-items:center;font-size:12px;color:var(--secondary-color);word-break:break-all;} 
.mono {font-family:'SF Mono',Monaco,'Cascadia Code','Roboto Mono',Consolas,monospace;font-size:12px;} 
.client-id {max-width:170px; width:170px; white-space:normal; word-break:break-all;}
.client-id code {display:block; line-height:1.25; word-break:break-all;}
@media (max-width:1100px){.client-id {max-width:140px;width:140px;}}
@media (max-width:680px){.client-id {max-width:100%;width:auto;}}
.client-name {font-weight:600;} 
.date-col {white-space:nowrap;font-size:12px;color:var(--secondary-color);} 
.action-col {display:flex;flex-direction:column;gap:6px;} 
.btn {border:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:600;padding:8px 12px;border-radius:8px;background:var(--border-color);color:var(--text-color);transition:.2s;} 
.btn:hover {transform:translateY(-2px);} 
.btn.small {padding:6px 10px;} 
.btn.primary {background:#6366f1;color:#fff;} 
.btn.primary:hover {background:#4f46e5;} 
.btn.warn {background:#f59e0b;color:#fff;} 
.btn.warn:hover {background:#d97706;} 
.btn.danger {background:#ef4444;color:#fff;} 
.btn.danger:hover {background:#dc2626;} 
.btn.full {width:100%;justify-content:center;font-size:14px;padding:12px 16px;} 
.form-group {margin-bottom:16px;display:flex;flex-direction:column;gap:6px;} 
.form-group label {font-size:13px;font-weight:600;color:var(--text-color);} 
.form-group input,.form-group textarea {border:2px solid var(--border-color);background:var(--card-bg);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--text-color);resize:vertical;transition:.2s;} 
.form-group input:focus,.form-group textarea:focus {outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.15);} 
.hint {font-size:11px;font-weight:500;color:var(--secondary-color);} 
.optional {font-size:11px;color:var(--secondary-color);} 
.form-footnote {font-size:12px;color:var(--secondary-color);margin:6px 0 14px;} 
.empty-state {text-align:center;padding:30px 10px;color:var(--secondary-color);} 
.empty-state i {font-size:30px;margin-bottom:10px;color:#6366f1;} 
/* Modal */
.modal-overlay {position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;} 
.modal-overlay.show {display:flex;} 
.modal {background:var(--card-bg);border:1px solid var(--border-color);border-radius:18px;max-width:560px;width:94%;box-shadow:0 25px 60px rgba(0,0,0,0.25);animation:pop .3s ease;padding:10px 0 0;display:flex;flex-direction:column;} 
@keyframes pop {from {opacity:0;transform:translateY(12px) scale(.96);} to {opacity:1;transform:translateY(0) scale(1);} } 
.modal-header {display:flex;align-items:center;justify-content:space-between;padding:14px 26px 10px;} 
.modal-header h3 {margin:0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:10px;} 
.modal-header .close {background:none;border:none;color:var(--secondary-color);cursor:pointer;font-size:16px;padding:8px;border-radius:8px;} 
.modal-header .close:hover {background:var(--bg-color);color:var(--text-color);} 
.modal-body {padding:10px 26px 26px;} 
.modal-actions {display:flex;justify-content:flex-end;gap:12px;margin-top:6px;} 
/* Alerts */
#actionStatus .alert {padding:14px 18px;border-radius:10px;font-size:14px;margin:0 0 18px;display:flex;align-items:center;gap:10px;font-weight:500;} 
.alert-info {background:rgba(59,130,246,0.1);color:#3b82f6;border:1px solid rgba(59,130,246,0.3);} 
.alert-danger {background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3);} 
.alert-warning {background:rgba(245,158,11,0.1);color:#d97706;border:1px solid rgba(245,158,11,0.3);} 
/* Responsive */
@media (max-width:1100px){.layout-grid {grid-template-columns:1fr;} .panel-list {order:2;} .panel-form {order:1;} }
@media (max-width:680px){.clients-header {flex-direction:column;align-items:flex-start;} .back-link {margin-left:0;} .action-col {flex-direction:row;flex-wrap:wrap;} }
</style>

<script>
async function submitCreate(e){
  e.preventDefault();
  const f = e.target;
  const payload = {
    name: f.name.value.trim(),
    website_url: f.website_url.value.trim() || null,
    description: f.description.value.trim() || null,
    redirect_uris: f.redirect_uris.value.split(/\n+/).map(s=>s.trim()).filter(Boolean)
  };
  const r = await fetch('/admin/clients/new', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const data = await r.json();
  if(r.ok){
    f.reset();
  }
  document.getElementById('actionStatus').innerHTML = r.ok ? `<div class='alert alert-info'><i class="fas fa-envelope"></i> Pending confirmation email sent. Token: <code>${data.token}</code></div>` : `<div class='alert alert-danger'><i class="fas fa-times-circle"></i> ${data.error||'Error'}</div>`;
}
async function rotateSecret(id){
  if(!confirm('Rotate secret for this client? Existing credentials may be invalidated once used. Proceed?')) return;
  const r = await fetch(`/admin/clients/${id}/rotate-secret`, {method:'POST'});
  const d = await r.json();
  document.getElementById('actionStatus').innerHTML = r.ok ? `<div class='alert alert-info'><i class="fas fa-sync"></i> Secret rotation pending email confirmation. Token: <code>${d.token}</code></div>` : `<div class='alert alert-danger'><i class="fas fa-times-circle"></i> ${d.error||'Error'}</div>`;
}
async function deleteClient(id){
  if(!confirm('Delete this client? This cannot be undone. Are you sure?')) return;
  const r = await fetch(`/admin/clients/${id}/delete`, {method:'POST'});
  const d = await r.json();
  document.getElementById('actionStatus').innerHTML = r.ok ? `<div class='alert alert-warning'><i class="fas fa-exclamation-triangle"></i> Deletion pending email confirmation. Token: <code>${d.token}</code></div>` : `<div class='alert alert-danger'><i class="fas fa-times-circle"></i> ${d.error||'Error'}</div>`;
}
function openUpdateModal(id){
  const modal = document.getElementById('updateModal');
  modal.querySelector('input[name="client_id"]').value = id;
  modal.classList.add('show');
  document.body.style.overflow='hidden';
}
function closeUpdateModal(){
  const modal = document.getElementById('updateModal');
  modal.classList.remove('show');
  document.body.style.overflow='';
  document.getElementById('updateClientForm').reset();
}
async function submitUpdate(e){
  e.preventDefault();
  const f = e.target;
  const client_id = f.client_id.value;
  const fields = {};
  if(f.name.value.trim()) fields.name = f.name.value.trim();
  if(f.description.value.trim()) fields.description = f.description.value.trim();
  if(f.website_url.value.trim()) fields.website_url = f.website_url.value.trim();
  if(f.redirect_uris.value.trim()) fields.redirect_uris = f.redirect_uris.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  if(Object.keys(fields).length===0){
    alert('No changes provided');
    return;
  }
  const r = await fetch(`/admin/clients/${client_id}/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fields)});
  const d = await r.json();
  closeUpdateModal();
  document.getElementById('actionStatus').innerHTML = r.ok ? `<div class='alert alert-info'><i class="fas fa-edit"></i> Update pending confirmation. Token: <code>${d.token}</code></div>` : `<div class='alert alert-danger'><i class="fas fa-times-circle"></i> ${d.error||'Error'}</div>`;
}
// Close modal on overlay click
document.getElementById('updateModal').addEventListener('click', (e)=>{ if(e.target.id==='updateModal') closeUpdateModal(); });
// Escape key
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && document.getElementById('updateModal').classList.contains('show')) closeUpdateModal(); });
</script>
{% endblock %}
